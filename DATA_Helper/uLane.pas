unit uLane;

interface

uses
  System.SysUtils, System.Classes, System.DateUtils,
  System.Variants, System.VarUtils,
  System.StrUtils,
  vcl.Dialogs, Data.DB,
  dmCORE, dmSCM2, uDefines,
	FireDAC.Comp.Client;

  function Assert(): boolean;
  function ClearLane(DoExclude: Boolean = true): boolean;
	function StrikeLane(DoExclude: Boolean = true): boolean;
  function DeleteLane: boolean;
  function GetLaneID(): integer; // Assert - SAFE.
  function LastLaneNum: integer;
  function Locate(aLaneID: integer): Boolean;
	function LocateNominee(aNomineeID: integer): boolean;
	function LocateTeam(aTeamID: integer): boolean;
  function PK(): integer; // NO CHECKS. RTNS: Primary key.
  function MoveDownLane(ADataSet: TDataSet): Boolean;
  function MoveUpLane(ADataSet: TDataSet): Boolean;
  function DeleteSplit(aSplitTimeID: integer): integer;
  function DeleteAllSplits(DoExclude: Boolean = true): integer;
  function DeleteWatch(aWatchTimeID: integer): integer;
  function DeleteAllWatches(DoExclude: Boolean = true): integer;
  procedure NewLane();


implementation

uses
 uSwimClub, uSession, uEvent, uHeat;


function Assert: Boolean;
begin
  result := false;
  if Assigned(CORE) then
    if CORE.qryLane.Active then
      if not CORE.qryLane.IsEmpty then
        result := true;
end;

function DeleteLane: boolean;
var
  SQL: string;
  doRenumber: boolean;
begin
  result := false;
  doRenumber := false;
  // Not permitted to DeleteLane events if session is locked.
  if uSession.IsLocked() then exit;
  // Can't delete this lane if it's be raced or closed.
  CORE.qryLane.DisableControls;
  CORE.qryWatchTime.DisableControls;
  CORE.qrySplitTime.DisableControls;
  try
    // D E L E T E   WATCH-TIMES...............................
    try
      // Only DeleteLane nominations if no heats exist.
      SQL :=
      'Delete FROM SwimClubMeet2.dbo.WatchTime WHERE WatchTime.LaneID = :ID';
      SCM2.scmConnection.ExecSQL(SQL, [uLane.PK]);
    finally
    end;
    // D E L E T E   SPLIT-TIMES...............................
    try
      // Only DeleteLane nominations if no heats exist.
      SQL :=
      'Delete FROM SwimClubMeet2.dbo.SplitTime WHERE SplitTime.LaneID = :ID';
      SCM2.scmConnection.ExecSQL(SQL, [uLane.PK]);
    finally
    end;
    // F I N A L L Y   D E L E T E   L A N E .
    try
      CORE.qryLane.Delete;
      doRenumber := true;
      result := true;
    except on E: Exception do
        // handle error
    end;
  finally
    if doRenumber then
    begin
      ; //nop
    end;

    CORE.qryWatchTime.ApplyMaster; // ASSERT MASTER-DETAILED.
    CORE.qrySplitTime.ApplyMaster; // ASSERT MASTER-DETAILED.
    CORE.qryLane.EnableControls;
    CORE.qryWatchTime.EnableControls;
    CORE.qrySplitTime.EnableControls;
  end;
end;


function GetLaneID(): integer;
begin
  result := 0;
  if uLane.Assert then // Assert.
      result := CORE.qryLane.FieldByName('LaneID').AsInteger;
end;

function ClearLane(DoExclude: Boolean = true): boolean;
begin
  result := false;
  if uSession.IsLocked() then exit;
  if (uHeat.HeatStatusID() = 1) or (DoExclude = false) then
  begin
    try
      CORE.qryLane.DisableControls;
      try
        CORE.qryLane.Edit;
        CORE.qryLane.FieldByName('TeamID').Clear;
        CORE.qryLane.FieldByName('NomineeID').Clear;
        CORE.qryLane.Post;
        result := true;
      except on E: Exception do
        CORE.qryLane.Cancel;
      end;
    finally
      CORE.qryLane.EnableControls;
    end;
  end;
end;

function StrikeLane(DoExclude: Boolean = true): boolean;
var
  SQL: string;
  recCount, aTeamID, aNomineeID: integer;
begin
  result := false;
  if uSession.IsLocked() then exit;
  if (uHeat.HeatStatusID() = 1) or (DoExclude = false) then
  begin
    // dbo.Lane.TeamID must be cleared before the teamlink can be removed.
    // dbo.Lane.NomineeID must be cleared before nominee can be removed.
    aTeamID := CORE.qryLane.FieldByName('TeamID').AsInteger; // store param
    aNomineeID := CORE.qryLane.FieldByName('NomineeID').AsInteger; // store param
    uLane.ClearLane(DoExclude); // NULL fields TeamID and NomineeID.
    if aNomineeID <> 0 then
    begin // delete nomination record.
      SQL := '''
        DELETE FROM SwimClubMeet2.dbo.Nominee
        WHERE NomineeID = :ID1 AND EventID = :ID2';
        ''';
      recCount := SCM2.scmConnection.ExecSQL( SQL,[aNomineeID, uEvent.PK()] );
    end;
    if aTeamID <> 0 then // Deletes dbo.teamlink and removes nominee from dbo.Nominee.
//      uTeam.StrikeTeam(aTeamID, DoExclude);
  end;
end;

function DeleteAllWatches(DoExclude: Boolean = true): integer;
var
SQL: string;
begin
  result := 0;
  if Assigned(SCM2) and SCM2.scmConnection.Connected then
  begin
    if uSession.IsLocked() then exit;
    if (uHeat.HeatStatusID() = 1) or (DoExclude = false) then
    begin
      CORE.qryLane.ApplyMaster;
      try
        CORE.qryLane.DisableControls;
        SQL := '''
          DELETE FROM SwimClubMeet2.dbo.WatchTimes
          WHERE [WatchTimes].[LaneID] = :ID;
          ''';
        SCM2.scmConnection.ExecSQL(SQL, [uLane.PK()]);
      finally
        CORE.qryLane.EnableControls;
      end;
    end;
  end;
end;

function DeleteWatch(aWatchTimeID: integer ): integer;
var
SQL: string;
begin
  result := 0;
  if Assigned(SCM2) and SCM2.scmConnection.Connected then
  begin
  if uSession.IsLocked() then exit;
    CORE.qrySplitTime.ApplyMaster;
    try
      CORE.qrySplitTime.DisableControls;
      SQL := '''
        DELETE FROM SwimClubMeet2.dbo.WatchTimes
        WHERE [WatchTimes].[SplitTimeID] = :ID AND [WatchTimes].[LaneID] = :ID;
        ''';
      result := SCM2.scmConnection.ExecSQL(SQL, VarArrayOf([aWatchTimeID, uLane.PK()]));
    finally
      CORE.qrySplitTime.EnableControls;
    end;
  end;
end;

function DeleteAllSplits(DoExclude: Boolean = true): integer;
var
SQL: string;
begin
  result := 0;
  if Assigned(SCM2) and SCM2.scmConnection.Connected then
  begin
    if uSession.IsLocked() then exit;
    if (uHeat.HeatStatusID() = 1) or (DoExclude = false) then
    begin
      CORE.qryLane.ApplyMaster;
      try
        CORE.qryLane.DisableControls;
        SQL := '''
          DELETE FROM SwimClubMeet2.dbo.SplitTimes
          WHERE [SplitTimes].[LaneID] = :ID;
          ''';
        SCM2.scmConnection.ExecSQL(SQL, [uLane.PK()]);
      finally
        CORE.qryLane.EnableControls;
      end;
    end;
  end;
end;

function DeleteSplit(aSplitTimeID: integer ): integer;
var
SQL: string;
begin
  result := 0;
  if Assigned(SCM2) and SCM2.scmConnection.Connected then
  begin
  if uSession.IsLocked() then exit;
    CORE.qrySplitTime.ApplyMaster;
    try
      CORE.qrySplitTime.DisableControls;
      SQL := '''
        DELETE FROM SwimClubMeet2.dbo.SplitTimes
        WHERE [SplitTimes].[SplitTimeID] = :ID AND [SplitTimes].[LaneID] = :ID;
        ''';
      result := SCM2.scmConnection.ExecSQL(SQL, VarArrayOf([aSplitTimeID, uLane.PK()]));
    finally
      CORE.qrySplitTime.EnableControls;
    end;
  end;
end;

procedure NewLane;
var
  aLaneNum: integer;
begin
  if CORE.qryHeat.IsEmpty then exit;
  // NOTE: renumbering must be done by caller.
  aLaneNum := LastLaneNum();
  if aLaneNum < uSwimClub.NumberOfLanes then
  begin
    Inc(aLaneNum);
    try
      CORE.qrySplitTime.DisableControls;
      CORE.qryWatchTime.DisableControls;
      CORE.qryLane.DisableControls;
      try
        CORE.qryLane.Insert;
        CORE.qryLane.FieldByName('HeatID').AsInteger := uHeat.PK();
        CORE.qryLane.FieldByName('LaneNum').AsInteger := aLaneNum;
        CORE.qryLane.FieldByName('IsDisqualified').AsBoolean := false;
        CORE.qryLane.FieldByName('IsScratched').AsBoolean := false;
        CORE.qryLane.FieldByName('TeamID').Clear;
        CORE.qryLane.FieldByName('NomineeID').Clear;
        CORE.qryLane.Post;
      except on E: Exception do
        CORE.qryLane.Cancel;
      end;
    finally
      CORE.qryLane.EnableControls;
      CORE.qrySplitTime.ApplyMaster;
      CORE.qryWatchTime.ApplyMaster;
      CORE.qrySplitTime.EnableControls;
      CORE.qryWatchTime.EnableControls;
    end;
  end;
end;

function LastLaneNum: integer;
var
  SQL: string;
  v: variant;
begin
  result := 0;
  if not Assigned(SCM2) and SCM2.scmConnection.Connected then exit;
  SQL := 'SELECT MAX(LaneNum) FROM SwimClubMeet2.dbo.Lane ' +
  'WHERE Lane.HeatID = :ID';
  v := SCM2.scmConnection.ExecSQLScalar(SQL, [uHeat.PK()]);
  if not VarIsNull(v) and not VarIsEmpty(v) and (v > 0) then result := v;
end;

function Locate(aLaneID: integer): Boolean;
var
  SearchOptions: TLocateOptions;
begin
  result := false;
  SearchOptions := [];
  if Assigned(CORE) and CORE.dsLane.DataSet.Active then
  begin
    CORE.qryWatchTime.DisableControls;
    CORE.qrySplitTime.DisableControls;
    CORE.qryLane.DisableControls;
    try
      result := CORE.qryLane.Locate('LaneID', aLaneID, SearchOptions);
      if result then 
      begin
        CORE.qryWatchTime.ApplyMaster;
        CORE.qrySplitTime.ApplyMaster;
      end;
    finally
      CORE.qryLane.EnableControls;
      CORE.qrySplitTime.EnableControls;
      CORE.qryWatchTime.EnableControls;
    end;   
  end;
end;

function LocateNominee(aNomineeID: integer): boolean;
var
  SearchOptions: TLocateOptions;
begin
  result := false;
  SearchOptions := [];
  if Assigned(CORE) and CORE.dsLane.DataSet.Active then
  begin
    CORE.qryWatchTime.DisableControls;
    CORE.qrySplitTime.DisableControls;
    CORE.qryLane.DisableControls;
    try
      result := CORE.qryLane.Locate('NomineeID', aNomineeID, SearchOptions);
      if result then
      begin
        CORE.qryWatchTime.ApplyMaster;
        CORE.qrySplitTime.ApplyMaster;
      end;
    finally
      CORE.qryLane.EnableControls;
      CORE.qrySplitTime.EnableControls;
      CORE.qryWatchTime.EnableControls;
    end;
  end;
end;

function LocateTeam(aTeamID: integer): boolean;
var
  SearchOptions: TLocateOptions;
begin
  result := false;
  SearchOptions := [];
  if Assigned(CORE) and CORE.dsLane.DataSet.Active then
  begin
    CORE.qryWatchTime.DisableControls;
    CORE.qrySplitTime.DisableControls;
    CORE.qryLane.DisableControls;
    try
      result := CORE.qryLane.Locate('TeamID', aTeamID, SearchOptions);
      if result then
      begin
        CORE.qryWatchTime.ApplyMaster;
        CORE.qrySplitTime.ApplyMaster;
      end;
    finally
      CORE.qryLane.EnableControls;
      CORE.qrySplitTime.EnableControls;
      CORE.qryWatchTime.EnableControls;
    end;
  end;
end;

function PK(): integer;
begin // NO CHECKS. quick and dirty - primary key result.
  result := CORE.qryLane.FieldByName('LaneID').AsInteger;
end;

function MoveDownLane(ADataSet: TDataSet): Boolean;
begin
//  result := SCM2.MoveDownLane(ADataSet);
  result := true;
end;

function MoveUpLane(ADataSet: TDataSet): Boolean;
begin
//  result := SCM2.MoveUpLane(ADataSet);
  result := true;
end;





end.

